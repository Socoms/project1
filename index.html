<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>부산광역시 119소방출동정보</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=7c0fd3e8259fada9fd77f430b455e8a4&libraries=services"></script>
</head>
<body>
  <h1>부산광역시 119소방출동정보</h1>

  <div class="region-buttons">
    <!-- 구별 버튼 동적으로 추가 -->
  </div>

  <div class="container">
    <div id="map"></div>
    <div id="fire-station-list" class="fire-station-list">
      <h3>소방서 목록</h3>
      <input type="text" id="search" placeholder="소방서 검색..." onkeyup="searchFireStations()">
      <ul id="fire-station-items"></ul>
    </div>
    <div id="detail-info" class="detail-info">
      <h3>상세 정보</h3>
      <div id="details"></div>
    </div>
  </div>

  <script>
    const apiUrl = "https://apis.data.go.kr/6260000/Busan119InfoService/getTodayInfo?serviceKey=yFPitygU2QfYS6aMV2iKuu5LWvUNJRo7BO3UTcdewom3aDkb8MrY2rR78tgQ9W3j%2BTFF6cScdVXmPSws46rm7Q%3D%3D&numOfRows=50&pageNo=1&resultType=json";

    const regions = {
      "강서구": { center: { lat: 35.2123, lng: 128.9801 } },
      "금정구": { center: { lat: 35.2423, lng: 129.0920 } },
      "기장군": { center: { lat: 35.2448, lng: 129.2217 } },
      "남구": { center: { lat: 35.1368, lng: 129.0863 } },
      "동구": { center: { lat: 35.1271, lng: 129.0560 } },
      "동래구": { center: { lat: 35.2043, lng: 129.0794 } },
      "부산진구": { center: { lat: 35.1598, lng: 129.0471 } },
      "북구": { center: { lat: 35.2113, lng: 129.0258 } },
      "사상구": { center: { lat: 35.1519, lng: 128.9882 } },
      "사하구": { center: { lat: 35.1046, lng: 128.9739 } },
      "서구": { center: { lat: 35.0912, lng: 129.0208 } },
      "수영구": { center: { lat: 35.1423, lng: 129.1142 } },
      "연제구": { center: { lat: 35.1848, lng: 129.0785 } },
      "영도구": { center: { lat: 35.0864, lng: 129.0680 } },
      "중구": { center: { lat: 35.1068, lng: 129.0327 } },
      "해운대구": { center: { lat: 35.1632, lng: 129.1636 } },
    };

    const fireStations = {}; // 구별 소방서 저장
    const markers = {}; // 마커 저장
    let map, currentInfowindow;

    window.onload = async function () {
      const mapContainer = document.getElementById('map');
      const mapOption = {
        center: new kakao.maps.LatLng(35.1796, 129.0756), // 부산광역시 중심 좌표
        level: 8 // 지도 확대 레벨
      };

      map = new kakao.maps.Map(mapContainer, mapOption);
      currentInfowindow = null;

      // 구별 버튼 동적 생성
      const regionButtons = document.querySelector('.region-buttons');
      for (let region in regions) {
        const button = document.createElement('button');
        button.className = 'region-btn';
        button.textContent = region;
        button.addEventListener('click', () => filterFireStationsByRegion(region));
        regionButtons.appendChild(button);
      }

      await fetchFireStationData();
    };

    // API 데이터 가져오기
    async function fetchFireStationData() {
      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.response.body.items.item) {
          const items = data.response.body.items.item;

          items.forEach(item => {
            const { dsraddr, juriswardid1, juriswardid2 } = item;

            // 주소에서 구 이름 추출하기
            const regionFromAddress = dsraddr.split(' ')[1]; // "부산 [구] ..."에서 [구] 추출

            // 구별로 소방서 목록에 추가
            if (!fireStations[regionFromAddress]) fireStations[regionFromAddress] = [];
            fireStations[regionFromAddress].push({
              name: juriswardid2,
              address: dsraddr,
              data: item,
            });

            // 주소를 바탕으로 지도에 마커 추가
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(dsraddr, (result, status) => {
              if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                const marker = new kakao.maps.Marker({
                  map: map,
                  position: coords
                });

                const infowindow = new kakao.maps.InfoWindow({
                  content: `<div style="padding:5px;"><strong>${juriswardid2}</strong><br>${dsraddr}</div>`
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                  if (currentInfowindow) currentInfowindow.close();
                  infowindow.open(map, marker);
                  currentInfowindow = infowindow;
                  updateDetails(item); // 소방서 클릭 시 상세 정보 업데이트
                });

                // 마커 저장
                if (!markers[regionFromAddress]) markers[regionFromAddress] = [];
                markers[regionFromAddress].push(marker);
              } else {
                console.error("주소 검색 실패: ", dsraddr);  // 오류 로그
              }
            });
          });
          renderFireStationList(); // 데이터 로딩 후 소방서 목록 렌더링
        } else {
          console.error("API 데이터에 소방서 항목이 없습니다.");
        }
      } catch (error) {
        console.error("API 호출 중 오류 발생:", error);
      }
    }

    // 소방서 목록 렌더링
    function renderFireStationList() {
      const listElement = document.getElementById('fire-station-items');
      listElement.innerHTML = ''; // 기존 목록 비우기

      for (let region in fireStations) {
        fireStations[region].forEach(station => {
          const li = document.createElement('li');
          li.className = 'fire-station-item';
          li.innerHTML = `
            <span>${station.name}</span>
            <small>(${station.address})</small>
          `;

          // 소방서 클릭 시 동작 추가
          li.addEventListener('click', () => {
            if (station.data.coords) {
              map.panTo(station.data.coords); // 지도 이동
              const marker = markers[region].find(marker =>
                marker.getPosition().equals(station.data.coords)
              );
              kakao.maps.event.trigger(marker, 'click'); // 마커 클릭 이벤트 발생
              updateDetails(station.data); // 상세 정보 업데이트
            }
          });

          listElement.appendChild(li);
        });
      }
    }

    // 상세 정보 업데이트
    function updateDetails(data) {
      const detailsElement = document.getElementById('details');
      detailsElement.innerHTML = `
        <p><strong>관할서:</strong> ${data.juriswardid1}</p>
        <p><strong>주소:</strong> ${data.dsraddr}</p>
        <p><strong>안전센터:</strong> ${data.juriswardid2}</p>
        <p><strong>재난 종류:</strong> ${data.dsrkndcd}</p>
        <p><strong>규모:</strong> ${data.dsrsizecd}</p>
        <p><strong>등급:</strong> ${data.dsrclscd}</p>
      `;
    }

    // 구별 소방서 목록 필터링 및 렌더링
    function filterFireStationsByRegion(region) {
      const listElement = document.getElementById('fire-station-items');
      listElement.innerHTML = ''; // 기존 목록 비우기

      // 해당 구에 속한 소방서만 필터링
      const filteredStations = fireStations[region] || [];
      
      // 필터링된 소방서가 없으면 "정보 없음" 표시
      if (filteredStations.length === 0) {
        listElement.innerHTML = '<li>해당 구역에 소방서 정보가 없습니다.</li>';
        return;
      }

      filteredStations.forEach(station => {
        const li = document.createElement('li');
        li.className = 'fire-station-item';
        li.innerHTML = `
          <span>${station.name}</span>
          <small>(${station.address})</small>
        `;
        li.addEventListener('click', () => {
          if (station.data.coords) {
            map.panTo(station.data.coords);
            const marker = markers[region].find(m =>
              m.getPosition().equals(station.data.coords)
            );
            if (marker) kakao.maps.event.trigger(marker, 'click');
            updateDetails(station.data);
          }
        });
        listElement.appendChild(li);
      });
    }

    // 소방서 검색
    function searchFireStations() {
      const searchQuery = document.getElementById('search').value.toLowerCase();
      const filteredStations = [];
      for (let region in fireStations) {
        fireStations[region].forEach(station => {
          if (station.name.toLowerCase().includes(searchQuery) || station.address.toLowerCase().includes(searchQuery)) {
            filteredStations.push(station);
          }
        });
      }
      
      const listElement = document.getElementById('fire-station-items');
      listElement.innerHTML = ''; // 기존 목록 비우기

      // 필터링된 소방서 목록 표시
      filteredStations.forEach(station => {
        const li = document.createElement('li');
        li.className = 'fire-station-item';
        li.innerHTML = `
          <span>${station.name}</span>
          <small>(${station.address})</small>
        `;
        li.addEventListener('click', () => {
          if (station.data.coords) {
            map.panTo(station.data.coords);
            const marker = markers[station.data.juriswardid1].find(m =>
              m.getPosition().equals(station.data.coords)
            );
            if (marker) kakao.maps.event.trigger(marker, 'click');
            updateDetails(station.data);
          }
        });
        listElement.appendChild(li);
      });
    }
  </script>
</body>
</html>
